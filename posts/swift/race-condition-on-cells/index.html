<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta name="author" content="Sendy Halim">
		<meta name="description" content="Sendy Halim's blog">
    <title>RxSwift Race Condition on Cells</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../assets/css/default.css" />
    <link rel="stylesheet" type="text/css" href="../../../assets/css/navigation.css" />
    <link rel="stylesheet" type="text/css" href="../../../assets/css/highlight-js.css" />
    <link rel="stylesheet" type="text/css" href="../../../assets/css/image.css" />
    <link rel="stylesheet" type="text/css" href="../../../assets/css/post.css" />
  </head>

  <!-- Global Site Tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-80328765-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-80328765-1');
  </script>

  <body>
    <div id="content">
      <nav>
  <a href="../../../">
    <span class="arrow">←</span> Home
  </a>
</nav>



<div class="post">
  <h1 class="title">RxSwift Race Condition on Cells</h1>

  <div class="headline">
    <div>
      04 Jul 2016
    </div>
    <div>
      <a href="../../../tags/swift/">swift</a>, <a href="../../../tags/rxswift/">rxswift</a>, <a href="../../../tags/macOS/">macOS</a>
    </div>
  </div>

  <div class="post-body">
    <p>A few days ago I wrote a simple code to asynchronously load an image using <a href="https://github.com/Moya/Moya#rxswift"><code>RxMoya</code></a>. <code>RxMoya</code> is an <a href="https://github.com/ReactiveX/RxSwift"><code>RxSwift</code></a> wrapper for <a href="https://github.com/Moya/Moya"><code>Moya</code></a>. The flow is simple, everytime collection view asks for <code>NSCollectionViewItem</code> (yes, I’m building a macOS app), I need to load the image asynchronously. Here’s a part of the implementation:</p>
<pre class="swift"><code>func collectionView(
  collectionView: NSCollectionView,
  itemForRepresentedObjectAtIndexPath indexPath: NSIndexPath
) -&gt; NSCollectionViewItem {
  let item = collectionView.makeItemWithIdentifier(
    &quot;ChapterItem&quot;,
    forIndexPath: indexPath
  ) as! ChapterItem

  let chapter = vm[indexPath.item]
  let chapterPageVm = ChapterPagesViewModel(..)

  // Fetch manga chapter pages
  chapterPageVm.fetch()

  chapterPageVm
    .chapterPages
    .drive(onNext: { _ in
      // After chapter pages are loaded
      // we will set chapter preview here
    })
    .addDisposableTo(disposeBag)

  ...

  return item
}</code></pre>
<p class="image-container">
<img src="https://i.imgflip.com/1b9y1.jpg" alt="Problem analysis" class="medium-size">
</p>
<p>Obviously there’s a problem with the implementation, how do I make sure that after the chapter pages are loaded, the execution context of <code>driveNext</code> is valid? In other words, how to make sure that the cell item has not been re-used (because if it is and I’m setting the fetched data, then there will be race condition)?</p>
<p>A solution that might work is by setting a <code>DisposeBag</code> to each cell and disposing it everytime <code>didEndDisplayingItem</code> gets called.</p>
<p class="image-container">
<img src="http://id.ragegenerator.com/images/ragebuilder-faces/Happy/09.png" alt="The solution" class="medium-size">
</p>
<p>Sounds like a perfect plan! Now I just need to find a way to set the dispose bags and keep track of them for each cell. Luckily <code>RxSwift</code> has a great community around it, <code>dpaschich</code> on <a href="http://rxswift.slack.com/">rxswift.slack.com</a> suggested to set <code>DisposeBag</code> on each of the cell item and disposing it using a custom method <code>didEndDisplaying</code></p>
<pre class="swift"><code>class ChapterItem: NSCollectionViewItem {
  @IBOutlet weak var chapterTitle: NSTextField!
  @IBOutlet weak var chapterNumber: NSTextField!
  @IBOutlet weak var chapterPreview: NSImageView!

  var disposeBag = DisposeBag()

  func didEndDisplaying() {
    chapterPreview.image = .None

    disposeBag = DisposeBag()
  }
}</code></pre>
<pre class="swift"><code>func collectionView(
  collectionView: NSCollectionView,
  didEndDisplayingItem item: NSCollectionViewItem,
  forRepresentedObjectAtIndexPath indexPath: NSIndexPath
) {
  let _item = item as! ChapterItem

  _item.didEndDisplaying()
}

func collectionView(
  collectionView: NSCollectionView,
  itemForRepresentedObjectAtIndexPath indexPath: NSIndexPath
) -&gt; NSCollectionViewItem {
  let item = collectionView.makeItemWithIdentifier(
    &quot;ChapterItem&quot;,
    forIndexPath: indexPath
  ) as! ChapterItem

  let chapter = vm[indexPath.item]
  let chapterPageVm = ChapterPagesViewModel(..)

  // Fetch manga chapter pages
  chapterPageVm.fetch()

  // Notice how I add disposable to item.disposeBag
  chapterPageVm
    .chapterPages
    .driveNext { _ in
      // After chapter pages are loaded
      // we will set chapter preview here
    } &gt;&gt;&gt; item.disposeBag

  ...

  return item
}</code></pre>
  </div>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'wavvel'; // Required - Replace '<example>' with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

    </div>

    <footer id="footer">
      <p class="small">
        © Copyright 2017 Sendy Halim
      </p>
      <p class="small">
        <a href="https://github.com/sendyhalim/blog" target="_blank">Source Code</a>
      </p>
    </footer>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
    <script src="../../../assets/js/highlight.js" type="text/javascript"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>
  </body>
</html>
